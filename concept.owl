module OwlUnit {
  const test_path = Path:join(File:pwd(), "test")

  fn main() {
    let (Ok, files) = File:ls(test_path)

    List:filter(files, test_file?)
      | List:each(_, run_tests_in\1)
  }

  private

  fn run_tests_in(filename) {
    let (Ok, module) = Code:load(filename)

    Module:functions(module)
      | List:filter(_, test_function?\1)
      | List:each(_, Function:apply(_, ()))
  }

  fn test_file?(filename) {
    String:ends_with?(filename, "_test.owl")
  }

  fn test_function?(fun) {
    Function:attrs(fun) | List:contains?(_, "test")
  }
}
